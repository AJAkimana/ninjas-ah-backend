<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="../css/style.css">
  <title>Chat</title>
</head>

<body>
  <div class="container shadow-2 radius-3 large-padding">
    <div class="bold loggedInUser"></div>
    <div id="message"></div>
    <h1 class="primary text-white radius-2 uppercase large-padding center-align">
      CHAT
    </h1>
    <br>
    <textarea id="chat" class="shadow-4 radius-2 medium-padding card" rows="5" placeholder="Type something"></textarea>
    <div class="center-align">
      <button type="button" id="send" class="radius-2 primary text-white center-align large-h-padding large-text">
        Send
      </button>
    </div>
  </div>
  <br>
  <div class="container shadow-2 radius-3 large-padding">
    <div id="chats" class="container primary card radius-2"></div>
  </div>
  <script>
    function displayUser() {
      const user = localStorage.user ? JSON.parse(localStorage.user) : null;

      if (user) {
        document.querySelector('.loggedInUser').innerHTML = `(${user.firstName} ${user.lastName})`;
      } else {
        window.location.replace(`${HOST}/mockups/login.html`)
        document.querySelector('.loggedInUser').innerHTML = '';
      }
    }

    async function sendChat(message) {
      const URL = `${HOST}/api/v1/chats`;
      let result = await sendData('POST', URL, message, 'json', localStorage.token);

      if (result) {
        console.log(result);
        if (typeof result === 'object' && result.errors) {
          document.querySelector('#message').innerHTML = `
          <div class="danger text-white radius-2 uppercase large-padding center-align">
            ${result.errors.authentication || result.errors.token || result.errors.account || result.errors.message}
          </div>`;
        } else {
          document.querySelector('#message').innerHTML = '';
        }
      }
    }

    async function getChats() {
      const URL = `${HOST}/api/v1/chats`;
      let result = await getData(URL, 'json', localStorage.token);

      if (result) {
        if (result.errors) {
          document.querySelector('#message').innerHTML = `
          <div class="danger text-white radius-2 uppercase large-padding center-align">
            ${result.errors.authentication || result.errors.token || result.errors}
          </div>`;
        } else {
          document.querySelector('#message').innerHTML = '';
          displayChats(result.chats);
        }
      }
    }
    function displayChats(chats) {
      let name = '';
      const user = localStorage.user ? JSON.parse(localStorage.user) : null;
      for (let i = 0; i < chats.length; i++) {
        if (user && user.firstName === chats[i].user.firstName && user.lastName === chats[i].user.lastName) {
          name = 'Me';
        } else {
          name = `${chats[i].user.firstName} ${chats[i].user.lastName}`;
        }
        document.querySelector("#chats").innerHTML += `
        <div id="chat${chats[i].id}" class="white card radius-2 small-padding ${name !== 'Me' ? 'right-align' : 'left-align'}">
          <b><u>${name}</u></b>
          <p>${chats[i].message}</p>
          <hr>
          ${displayDeleteChatButton(chats[i].userId, chats[i].id)}
          <small>
            <i>
              ${new Date(chats[i].createdAt).toDateString()} ||
              ${new Date(chats[i].createdAt).getHours()}:
              ${new Date(chats[i].createdAt).getMinutes()}
            </i>
          </small>
        </div>`;
      }
    }

    function addChat(chat) {
      let name = '';
      const user = localStorage.user ? JSON.parse(localStorage.user) : null;
      if (user && user.firstName === chat.user.firstName && user.lastName === chat.user.lastName) {
        name = 'Me';
      } else {
        name = `${chat.user.firstName} ${chat.user.lastName}`;
      }
      document.querySelector("#chats").innerHTML = `
      <div id="chat${chat.id}" class="white card radius-2 small-padding ${name !== 'Me' ? 'right-align' : 'left-align'}">
        <b><u>${name}</u></b>
        <p>${chat.message}</p>
        <hr>
        ${displayDeleteChatButton(chat.userId, chat.id)}
        <small>
          <i>
            ${new Date(chat.createdAt).toDateString()} ||
            ${new Date(chat.createdAt).getHours()}:
            ${new Date(chat.createdAt).getMinutes()}
          </i>
        </small>
      </div>` + document.querySelector("#chats").innerHTML;
    }

    function displayDeleteChatButton(userId, chatId) {
      const user = localStorage.user ? JSON.parse(localStorage.user) : null;

      if (user && user.id === userId) {
        return `<button class="danger radius-2 small-padding text-white" onclick="deleteChat(${chatId})">delete</button>`
      }

      return '';
    }

    async function deleteChat(chatId) {
      // document.querySelector(`#chat${chatId}`).remove();
      const URL = `${HOST}/api/v1/chats/${chatId}`;
      let result = await sendData('DELETE', URL, {}, 'json', localStorage.token);
      console.log(result);

      if (result) {
        if (typeof result === 'object' && result.errors) {
          document.querySelector('#message').innerHTML = `
          <div class="danger text-white radius-2 uppercase large-padding center-align">
            ${result.errors.authentication || result.errors.token || result.errors.account || result.errors.chat}
          </div>`;
        } else {
          document.querySelector('#message').innerHTML = '';
          document.querySelector(`#chat${chatId}`).remove();
        }
      }
    }

    window.document.addEventListener('DOMContentLoaded', () => {
      displayUser();
      const socket = io();
      socket.on("message", addChat)

      document.querySelector('#send').onclick = (e) => {
        if (document.querySelector("#chat").value) {
          sendChat({
            message: document.querySelector("#chat").value
          });
          document.querySelector("#chat").value = ''; // clear text area
        }
      }
      getChats()
    });
  </script>
  <script src="../js/index.js"></script>
</body>

</html>